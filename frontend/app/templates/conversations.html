<!-- frontend/templates/conversations.html -->
{% extends "base.html" %} {% block content %}
<div class="container">
  <div class="sidebar">
    <h3>Contacts</h3>
    <ul>
      {% for user in users %}
      <li
        class="user {% if user.id == selected_user_id %}active{% endif %}"
        onclick="selectUser({{ user.id }}, '{{ user.username | e }}')"
      >
        {{ user.username | e }}
      </li>
      {% endfor %}
    </ul>
  </div>
  <div class="content">
    {% if selected_user_id %} {% set selected_user = users | selectattr('id',
    'equalto', selected_user_id) | first %} {% if selected_user %}
    <h3>Chat with {{ selected_user.username | e }}</h3>
    <div class="messages" id="messages">
      {% for msg in messages %}
      <div
        class="message {% if msg.sender_id == user_id %}sent{% else %}received{% endif %}"
      >
        <p>
          <strong>
            {{ 'You' if msg.sender_id == user_id else 'User ' +
            msg.sender_id|string }}
          </strong>
          : {{ msg.content | e }}
        </p>
        <span>{{ msg.timestamp }}</span>
      </div>
      {% endfor %}
    </div>
    <form id="messageForm" method="POST">
      <input
        type="hidden"
        id="recipient_id"
        name="recipient_id"
        value="{{ selected_user_id }}"
      />
      <div class="form-group">
        <input
          type="text"
          name="content"
          id="content"
          placeholder="Type a message"
          required
        />
        <button type="submit">Send</button>
      </div>
    </form>
    {% else %}
    <p>Selected user not found.</p>
    {% endif %} {% else %}
    <p>Select a contact to start chatting.</p>
    {% endif %}
  </div>
</div>

<script>
  const token = "{{ token }}";
  const userId = "{{ user_id }}";
  let selectedUserId = {{ selected_user_id if selected_user_id else 'null' }};
  let ws = null;

  // Définir BACKEND_URL pour JavaScript
  const BACKEND_URL = "{{ BACKEND_URL }}";

  function selectUser(userId, username) {
    // Rediriger vers la même page avec le paramètre user_id
    window.location.href = `/conversations?user_id=${userId}`;
  }

  function connectWebSocket() {
    if (ws) {
      ws.close();
    }
    if (!selectedUserId) {
      return;
    }

    const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    // Extraire l'hôte et le port du BACKEND_URL
    const backendHost = new URL(BACKEND_URL).host;  // 'localhost:8000'
    ws = new WebSocket(`${wsProtocol}://${backendHost}/ws/${token}`);

    ws.onopen = function (event) {
      console.log("WebSocket connection established.");
    };

    ws.onmessage = function (event) {
      const message = JSON.parse(event.data);

      switch (message.type) {
        case "new_message":
          // Vérifier si le message concerne la conversation actuelle
          if (message.data.sender_id === selectedUserId || message.data.recipient_id === selectedUserId) {
            const messagesDiv = document.getElementById("messages");
            const newMessage = document.createElement("div");
            newMessage.classList.add("message");
            newMessage.classList.add(message.data.sender_id === userId ? "sent" : "received");
            newMessage.innerHTML = `
              <p><strong>${message.data.sender_id === userId ? 'You' : 'User ' + message.data.sender_id}</strong>: ${message.data.content}</p>
              <span>${new Date(message.data.timestamp).toLocaleString()}</span>
            `;
            messagesDiv.appendChild(newMessage);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
          }
          break;

        case "new_user":
          // Ajouter ce nouvel utilisateur à la liste des utilisateurs
          const usersList = document.querySelector(".sidebar ul");
          // Vérifier si l'utilisateur existe déjà dans la liste
          if (!Array.from(usersList.children).some(li => li.textContent === message.data.username)) {
            const li = document.createElement("li");
            li.classList.add("user");
            li.setAttribute("onclick", `selectUser(${message.data.id}, '${message.data.username | e}')`);
            li.textContent = message.data.username;
            usersList.appendChild(li);
          }
          break;

        default:
          console.log("Unknown message type:", message.type);
      }
    };

    ws.onclose = function (event) {
      console.log("WebSocket connection closed.");
      // Optionnel : essayer de se reconnecter après un certain délai
      setTimeout(connectWebSocket, 5000);
    };

    ws.onerror = function (error) {
      console.error("WebSocket error:", error);
    };
  }

  // Connect WebSocket when the page loads and a user is selected
  window.onload = function () {
    if (selectedUserId) {
      connectWebSocket();
    }
  };

  // Reconnect WebSocket if the selected user changes
  window.onbeforeunload = function () {
    if (ws) {
      ws.close();
    }
  };

  // Handle form submission via AJAX to prevent page reload
  const form = document.getElementById("messageForm");
  if (form) {
    form.addEventListener("submit", function(e) {
      e.preventDefault();
      const recipientId = document.getElementById("recipient_id").value;
      const content = document.getElementById("content").value;
      const headers = {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      };

      fetch(`${BACKEND_URL}/messages/`, {
        method: "POST",
        headers: headers,
        body: JSON.stringify({
          "recipient_id": parseInt(recipientId),
          "content": content
        })
      })
      .then(response => {
        if (response.ok) {
          // Optionnel : vider le champ de saisie
          document.getElementById("content").value = "";
        } else {
          alert("Failed to send message.");
        }
      })
      .catch(error => {
        console.error("Error sending message:", error);
        alert("An error occurred.");
      });
    });
  }
</script>

{% endblock %}
