<!-- frontend/templates/conversations.html -->
{% extends "base.html" %} {% block content %}
<div class="container">
  <div class="sidebar">
    <h3>Contacts</h3>
    <ul>
      {% for user in users %}
      <li
        class="user {% if user.id == selected_user_id %}active{% endif %}"
        onclick="selectUser({{ user.id }}, '{{ user.username }}')"
      >
        {{ user.username }}
      </li>
      {% endfor %}
    </ul>
  </div>
  <div class="content">
    {% if selected_user_id %}
    <h3>
      Chat with {{ users | selectattr('id', 'equalto', selected_user_id) |
      first.username }}
    </h3>
    <div class="messages" id="messages">
      {% for msg in messages %}
      <div
        class="message {% if msg.sender_id == user_id %}sent{% else %}received{% endif %}"
      >
        <p>
          <strong
            >{{ 'You' if msg.sender_id == user_id else 'User ' +
            str(msg.sender_id) }}</strong
          >
          >: {{ msg.content }}
        </p>
        <span>{{ msg.timestamp }}</span>
      </div>
      {% endfor %}
    </div>
    <form id="messageForm" method="POST">
      <input
        type="hidden"
        id="recipient_id"
        name="recipient_id"
        value="{{ selected_user_id }}"
      />
      <div class="form-group">
        <input
          type="text"
          name="content"
          id="content"
          placeholder="Type a message"
          required
        />
        <button type="submit">Send</button>
      </div>
    </form>
    {% else %}
    <p>Select a contact to start chatting.</p>
    {% endif %}
  </div>
</div>

<script>
  const token = "{{ token }}";
  const userId = "{{ user_id }}";
  let selectedUserId = {{ selected_user_id if selected_user_id else 'null' }};
  let ws = null;

  function selectUser(userId, username) {
    // Rediriger vers la même page avec le paramètre user_id
    window.location.href = `/conversations?user_id=${userId}`;
  }

  function connectWebSocket() {
    if (ws) {
      ws.close();
    }
    if (!selectedUserId) {
      return;
    }
    const wsProtocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    ws = new WebSocket(`${wsProtocol}://${window.location.host}/ws/${token}`);

    ws.onopen = function (event) {
      console.log("WebSocket connection established.");
    };

    ws.onmessage = function (event) {
      const message = JSON.parse(event.data);
      // Vérifier si le message appartient à la conversation actuelle
      if (message.sender_id === selectedUserId || message.recipient_id === selectedUserId) {
        const messagesDiv = document.getElementById("messages");
        const newMessage = document.createElement("div");
        newMessage.classList.add("message");
        newMessage.classList.add(message.sender_id === userId ? "sent" : "received");
        newMessage.innerHTML = `
          <p><strong>${message.sender_id === userId ? 'You' : 'User ' + message.sender_id}</strong>: ${message.content}</p>
          <span>${new Date(message.timestamp).toLocaleString()}</span>
        `;
        messagesDiv.appendChild(newMessage);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }
    };

    ws.onclose = function (event) {
      console.log("WebSocket connection closed.");
    };

    ws.onerror = function (error) {
      console.error("WebSocket error:", error);
    };
  }

  // Connect WebSocket when the page loads and a user is selected
  window.onload = function () {
    if (selectedUserId) {
      connectWebSocket();
    }
  };

  // Reconnect WebSocket if the selected user changes
  window.onbeforeunload = function () {
    if (ws) {
      ws.close();
    }
  };

  // Handle form submission via AJAX to prevent page reload
  const form = document.getElementById("messageForm");
  if (form) {
    form.addEventListener("submit", function(e) {
      e.preventDefault();
      const recipientId = document.getElementById("recipient_id").value;
      const content = document.getElementById("content").value;
      const headers = {
        "Authorization": `Bearer ${token}`,
        "Content-Type": "application/json"
      };

      fetch(`${BACKEND_URL}/messages/`, {
        method: "POST",
        headers: headers,
        body: JSON.stringify({
          "recipient_id": parseInt(recipientId),
          "content": content
        })
      })
      .then(response => {
        if (response.ok) {
          // Optionally, clear the input field
          document.getElementById("content").value = "";
        } else {
          alert("Failed to send message.");
        }
      })
      .catch(error => {
        console.error("Error sending message:", error);
        alert("An error occurred.");
      });
    });
  }
</script>
{% endblock %}
